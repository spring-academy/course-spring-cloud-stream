+++
title="Spring Cloud Stream in Action"
+++

Let's have some fun!

We will run both of our applications, and use Kafka's monitoring script to alternatively watch the output of **Source** and **Processor** applications.

You'll notice that we will prefix our `bootRun` commands with the project prefix for each app.

1. Monitor the **Source** app's messages.

   First, let's watch the `approvalRequest-out-0` topic, which should not have any activity yet:

   ```dashboard:open-dashboard
   name: Terminal
   ```

   ```shell
   [~/exercises] $ docker exec -it kafka /opt/kafka/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic approvalRequest-out-0
   ```

   In fact, the Kafka monitoring script complains that `approvalRequest-out-0` is an `UNKNOWN_TOPIC_OR_PARTITION`! Don't worry about this, it is not a problem.

1. Run the **Source** app.

   Next, let's run the **Source** application in an unused **Terminal** pane, which should trigger output to the Kafka terminal.

   ```shell
   [~/exercises] $ ./gradlew cashcard-transaction-source:bootRun
   ```

   In the Kafka pane, you should see transactions generated:

   ```shell
   [~/exercises] $ docker exec -it kafka /opt/kafka/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic approvalRequest-out-0
   ...
   {"id":-129536175288455261,"cashCard":{"id":-209358037067754430,"owner":"sarah1","amountRequestedForAuth":49.1793551196369}}
   {"id":7009916944740300434,"cashCard":{"id":-5079075037389245336,"owner":"sarah1","amountRequestedForAuth":71.42831472461903}}
   ...
   ```

   Great! We're producing transactions just as we have in prior labs.

   Let's switch our attention to the **Processor** application now.

1. Monitor the **Processor** app's messages.

   In the Kafka pane, stop the Kafka monitor with the `CTL+C` command.

   Then, run the monitoring command again, this time watching the **Processor**'s output topic, `enrichTransaction-out-0`

   ```shell
   [~/exercises] $ docker exec -it kafka /opt/kafka/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic enrichTransaction-out-0
   ```

   Again, there should be no activity yet, as we do not have an application sending any messages here. That is, our enricher is not producing `EnrichedTransaction`s yet.

1. Run the **Processor**.

   Here's where we finally need to specify which topics are in play.

   As we mentioned in earlier:

   > To work with the default configuration generated by Spring Cloud Stream, we will need to specify the **Processor** input** to be the **Source** output** when running our applications.

   Thus, we will configure `enrichTransaction-in-0.destination` to be `approvalRequest-out-0`.

   ![Pub/Sub topics](/workshop/content/assets/topics.svg)

   Here's what the `bootRun` command looks like, passing in the correct `destination` parameter:

   ```shell
   [~/exercises] $ ./gradlew cashcard-transaction-enricher:bootRun --args="--spring.cloud.stream.bindings.enrichTransaction-in-0.destination=approvalRequest-out-0"
   ```

   Now, the Kafka pane is printing enriched transactions!

   ```shell
   [~/exercises] $ ./gradlew cashcard-transaction-enricher:bootRun --args="--spring.cloud.stream.bindings.enrichTransaction-in-0.destination=approvalRequest-out-0"
   {"id":4409799809047780101,"cashCard":{"id":-6441105477669374372,"owner":"sarah1","amountRequestedForAuth":34.4198089960873},"approvalStatus":"APPROVED","cardHolderData":{"userId":"469e0fde-7400-4b2f-8299-fb3fb905aa04","name":"sarah1","address":"123 Main street"}}
   ...
   ```

   We've done it! We're processing `Transaction`s and producing `EnrichedTransaction`s.

1. Stop the **Source** app and watch the activity stop.

   Just to prove that the **Source** is the source, stop the source app with `CTL+C`:

   ```shell
   <==========---> 80% EXECUTING [15m 55s]
   > :cashcard-transaction-source:bootRun
   ^C[~/exercises] $
   ```

   You'll see that activity stops in the Kafka pane, which is monitoring the enriched transactions.

   Why? Because, without the **Source** app producing `Transaction`s, the **Processor** cannot generated `EnrichedTransaction`s.

Congratulations, it all works!
